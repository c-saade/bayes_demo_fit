---
title: "Unraveling Time Series with RStan: A Bayesian Approach to Demographic Modeling"
author: "Camille Saade"
date: '2023-07-27'
output:
  html_document:
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Demographic models are an invaluable tool in ecology, as they offer insights into the dynamics of species over time.
By estimating ecologically relevant parameters - such as growth rates and competition strength - these models shed light on complex ecological systems and eventually to predict their future dynamics or produce in-silico experiments.

However, fitting these models can be quite complex and using them for prediction requires robust parameter estimation for prediction purpose.
In particular, traditional frequentist approaches often lack the flexibility to accomodate complex models and they offer point estimates which risk missing identifiability issues.
Bayesian approaches on the other hand, are well suited to estimate parameter distributions and allow to identify pathological correlations between parameters at a glance.

In this article, we will use RStan - a bayesian statistical R package - to analyze time series of two interacting species and find out the mechanisms underlying their dynamics.

## Data

In one of my [research projects](https://doi.org/10.1098/rspb.2022.0543) I studied ecosystems recovery dynamics using microcosms - _i.e._, small laboratory ecosystems made up of microorganisms.
To overcome laboratory limitations of experiment duration and ecosystem size, I also reproduced and expanded the experiment _in silico_.
To get a robust parameterization of the simulations, I fitted a demographic model to preliminary data.
Let us work with this preliminary data, consisting of growth curves of several unicellular species in isolation and in co-culture: 

```{r}
density_data = read.csv("./Data/density_data.csv", header = T, sep = ',')
head(density_data, 10)
```

Each line contains the density (individuals/mL) of each species in one of the tubes (identified by the column 'file') at a given point in time (given either by the columns 'date' and 'time' or by the column 'hours').
Each species association ('community') was replicated three times, and replicates are differentiated using the 'replicate' column.
The columns 'Tet', 'Pca', 'Ble' and 'Col' describe the density of four unicellular species, respectively _Tetrahymena thermophila_, _Paramecium caudatum_, _Colpidium_ sp. and _Blepharisma_ sp.

Here is a summary of the columns content:

  - "file": the name of the video sample used for species count and identification, serves as a unique id for each tube.
  - "date": date at which the sample was taken (yyyy-mm-dd).
  - "time": the time of day at which the sample was taken (hour).
  - "community": the species grown in a tube.
  - "replicate": the replicate number.
  - "measure_point": the number of the measurement (t0 to t11)
  - "Tet": the density (individuals/mL) of _Tetrahymena thermophila_
  - "Pca": the density (individuals/mL) of _Paramecium caudatum_ (a species initially considered in the pilot, not used in the final study)
  - "Col": the density (individuals/mL) of _Colpidium_ sp.
  - "Ble": the density (individuals/mL) of _Blepharisma_ sp.
  - "hours": the time passed since the beginning of the culture (in hours).

Let us take a look at the data:
```{r, warning=FALSE, message = FALSE}
library(tidyverse)
theme_set(theme_light())
density_data %>%
  mutate(Ble = replace(Ble, !grepl('Ble', community), NA)) %>%
  mutate(Col = replace(Col, !grepl('Col', community), NA)) %>%
  mutate(Tet = replace(Tet, !grepl('Tet', community), NA)) %>%
  mutate(Pca = replace(Pca, !grepl('Pca', community), NA)) %>%
  pivot_longer(cols = c("Ble", "Col", "Tet", "Pca"),
               names_to = "species",
               values_to = "density") %>%
  ggplot() +
  geom_point(mapping = aes(x = hours, y = density, color = species)) +
  geom_line(mapping = aes(x = hours, y = density, color = species, group = interaction(species, replicate)), alpha = 0.5) +
  scale_y_continuous(trans='log2') +
  facet_wrap(community ~ .) +
  ylab('Species density (log2(indiv./mL))') +
  xlab('Time (h)')
```
We show here the density (on a log scale) over time of species for each species combination.
This makes a large data set on which to fit a single model.
For the sake of simplicity, we will work only on a subset of the data: the co-culture of _Blepharisma_ sp. and _Tetrahymena_ sp., and we will average the data across replicates.
If you wish to explore how to take advantage of monocultures, tri-cultures and replications, you can have a look into the papers [data and code](https://doi.org/10.5281/zenodo.6364903).
Let's filter the data and average across replicates:

```{r}
filtered_data <- 
  density_data %>%
  filter(community == 'Ble_Tet') %>% # keeping only the bi-specific time series (Blepharisma sp. + Tetrahymena sp.)
  select(c(measure_point, hours, Ble, Tet)) %>% # keeping only time variables and species densities
  group_by(measure_point) %>% # averaging each measurement over replicates
  summarise(t = mean(hours), n1 = mean(Ble), n2 = mean(Tet)) %>%
  arrange(t) # sorting by time
```

```{r}
library(ggpubr)

panel_a = ggplot(data = filtered_data) +
  geom_point(mapping = aes(x = t, y = n1), color = 'blue') +
  xlab('Time (h)') +
  ylab('Density of Blepharisma sp. (indiv./mL)')

panel_b = ggplot(data = filtered_data) +
  geom_point(mapping = aes(x = t, y = n2), color = 'red') +
  xlab('Time (h)') +
  ylab('Density of Tetrahymena sp. (indiv./mL)')

ggarrange(panel_a, panel_b, nrow = 2)
```

We end up with a single time series for _Blepharisma_ sp. (blue) and for _Tetrahymena_ sp. (red), which is much more manageable in the context of this guide. 
The last thing we want to do is transform this data into a list that is manageable by Rstan:

```{r}
# turning data into a list to give to the Rstan sampler.
data = list(n  = nrow(filtered_data), # number of observations
            t = filtered_data$t, # vector of times
            n1 = filtered_data$n1, # vector of density of species 1 (Ble)
            n2 = filtered_data$n2) # vector of density of species 2 (Tet)
```


